<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tanque Team | Dashboard Aluno</title>
    
    <!-- Favicon -->
    <link rel="icon" href="https://i.ibb.co/mC2zPJbm/1771300330359.png" type="image/png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            red: '#D90429',
                            dark: '#1B1B1B',
                            gray: '#2B2D42',
                            light: '#EDF2F4'
                        }
                    },
                    fontFamily: {
                        sans: ['Roboto', 'sans-serif'],
                        display: ['Oswald', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        .loader {
            border-top-color: #D90429;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-brand-dark transition-opacity duration-500">
        <div class="text-center">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4 mx-auto"></div>
            <h2 class="text-white font-display text-xl animate-pulse">CARREGANDO DOJO...</h2>
            <p id="loading-text" class="text-gray-400 text-xs mt-2">Verificando credenciais...</p>
        </div>
    </div>

    <!-- Redirect Message Overlay (Hidden by default) -->
    <div id="redirect-overlay" class="fixed inset-0 z-[60] hidden flex flex-col items-center justify-center bg-black/90 text-white p-4 text-center">
        <i class="fa-solid fa-lock text-4xl mb-4 text-brand-red"></i>
        <h2 class="text-xl font-bold mb-2">Acesso Restrito</h2>
        <p class="text-gray-300 mb-6">Você não está logado. Em um site real, você seria redirecionado.</p>
        <a href="login_aluno.html" class="px-6 py-2 bg-brand-red rounded hover:bg-red-700 transition">Ir para Login (Manual)</a>
    </div>

    <div class="flex h-screen overflow-hidden">
        
        <!-- Sidebar (Desktop) -->
        <aside class="hidden md:flex flex-col w-64 bg-brand-dark text-white shadow-xl z-10">
            <div class="p-6 flex items-center justify-center border-b border-gray-800">
                <img src="https://i.ibb.co/mC2zPJbm/1771300330359.png" alt="Logo" class="h-12 w-auto">
                <span class="ml-3 font-display font-bold text-xl tracking-wider">TANQUE TEAM</span>
            </div>
            <nav class="flex-1 px-4 py-6 space-y-2">
                <a href="#" class="flex items-center px-4 py-3 bg-brand-red text-white rounded-lg shadow-md transition-transform transform hover:translate-x-1">
                    <i class="fa-solid fa-chart-line w-6"></i>
                    <span class="font-bold">Dashboard</span>
                </a>
                <a href="#" class="flex items-center px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition-colors">
                    <i class="fa-solid fa-calendar-check w-6"></i>
                    <span>Presenças</span>
                </a>
                <a href="#" class="flex items-center px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition-colors">
                    <i class="fa-solid fa-file-invoice-dollar w-6"></i>
                    <span>Financeiro</span>
                </a>
                <a href="#" class="flex items-center px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition-colors">
                    <i class="fa-solid fa-user-gear w-6"></i>
                    <span>Meus Dados</span>
                </a>
            </nav>
            <div class="p-4 border-t border-gray-800">
                <button onclick="handleLogout()" class="flex items-center w-full px-4 py-2 text-red-400 hover:text-red-300 transition-colors">
                    <i class="fa-solid fa-right-from-bracket w-6"></i>
                    <span>Sair do Sistema</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col h-full overflow-hidden relative">
            
            <!-- Mobile Header -->
            <header class="md:hidden bg-brand-dark text-white p-4 flex justify-between items-center shadow-md z-20">
                <div class="flex items-center">
                    <img src="https://i.ibb.co/mC2zPJbm/1771300330359.png" alt="Logo" class="h-8 w-auto mr-2">
                    <span class="font-display font-bold text-lg">TANQUE TEAM</span>
                </div>
                <button onclick="handleLogout()" class="text-white focus:outline-none">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </button>
            </header>

            <!-- Scrollable Content -->
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-4 md:p-8">
                
                <!-- Welcome Section -->
                <div class="mb-8 flex justify-between items-end">
                    <div>
                        <p class="text-gray-500 text-sm uppercase font-bold tracking-wider mb-1">Bem-vindo de volta,</p>
                        <h1 class="text-3xl md:text-4xl font-display font-bold text-brand-dark" id="student-name-display">Carregando...</h1>
                    </div>
                    <div class="hidden md:block">
                        <span class="bg-white px-4 py-2 rounded-full shadow-sm text-sm font-bold text-gray-600 border border-gray-200">
                            <i class="fa-regular fa-calendar mr-2 text-brand-red"></i> <span id="current-date">--/--/----</span>
                        </span>
                    </div>
                </div>

                <!-- Status Cards Grid -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    
                    <!-- Card 1: Belt Status -->
                    <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-brand-red relative overflow-hidden">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest">Graduação Atual</h3>
                                <p class="text-xl font-bold text-brand-dark mt-1" id="belt-text">--</p>
                            </div>
                            <div class="p-2 bg-gray-50 rounded-lg text-brand-dark">
                                <i class="fa-solid fa-medal text-xl"></i>
                            </div>
                        </div>
                        <!-- Belt Visual Render Area -->
                        <div id="belt-visual-container" class="w-full h-12 flex items-center justify-center bg-gray-100 rounded border border-gray-200 shadow-inner">
                            <span class="text-xs text-gray-400">Carregando faixa...</span>
                        </div>
                        <p class="text-xs text-gray-400 mt-4 text-right">Mantenha a constância para evoluir.</p>
                    </div>

                    <!-- Card 2: Financial Status -->
                    <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-gray-800">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest">Status da Matrícula</h3>
                                <div id="payment-status-badge" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold mt-2 bg-gray-200 text-gray-600">
                                    Verificando...
                                </div>
                            </div>
                            <div class="p-2 bg-gray-50 rounded-lg text-green-600">
                                <i class="fa-solid fa-check-circle text-xl"></i>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm text-gray-600">Plano: <span class="font-bold text-brand-dark" id="plan-display">--</span></p>
                            <p class="text-xs text-gray-400 mt-1">Vencimento do contrato: <span id="contract-end">--/--/----</span></p>
                        </div>
                    </div>

                    <!-- Card 3: Quick Stats (Mockup) -->
                    <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest">Frequência</h3>
                                <p class="text-3xl font-bold text-brand-dark mt-1">0 <span class="text-sm font-normal text-gray-400">aulas</span></p>
                            </div>
                            <div class="p-2 bg-gray-50 rounded-lg text-blue-600">
                                <i class="fa-solid fa-fire text-xl"></i>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-200 mt-2">
                            <div class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                        <p class="text-xs text-gray-400 mt-2">Check-ins este mês.</p>
                    </div>
                </div>

                <!-- Personal Data Section -->
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="bg-brand-dark px-6 py-4 border-b border-gray-700 flex justify-between items-center">
                        <h3 class="text-white font-display font-bold tracking-wide">DADOS CADASTRAIS</h3>
                        <button class="text-xs text-gray-400 hover:text-white transition"><i class="fa-solid fa-pen-to-square mr-1"></i> Solicitar Alteração</button>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nome Completo</label>
                                <div class="p-3 bg-gray-50 rounded border border-gray-200 text-gray-800 font-medium" id="data-name">--</div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">E-mail</label>
                                <div class="p-3 bg-gray-50 rounded border border-gray-200 text-gray-800 font-medium" id="data-email">--</div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">CPF</label>
                                <div class="p-3 bg-gray-50 rounded border border-gray-200 text-gray-800 font-medium" id="data-cpf">--</div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Telefone</label>
                                <div class="p-3 bg-gray-50 rounded border border-gray-200 text-gray-800 font-medium" id="data-phone">--</div>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Endereço</label>
                                <div class="p-3 bg-gray-50 rounded border border-gray-200 text-gray-800 font-medium" id="data-address">--</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8 text-center text-xs text-gray-400">
                    &copy; 2026 Tanque Team BJJ. Todos os direitos reservados. Oss.
                </div>
            </main>
        </div>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCWlrrfNn6q4GhhL2H7goHjQMd3MsprxOE",
            authDomain: "tanqueteambjj.firebaseapp.com",
            projectId: "tanqueteambjj",
            storageBucket: "tanqueteambjj.firebasestorage.app",
            messagingSenderId: "410605992451",
            appId: "1:410605992451:web:f0f341f4594fe75f376c36",
            measurementId: "G-SW8PP8X7WM"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "tanqueteam-bjj";

        // --- SAFE REDIRECT HELPER ---
        function safeRedirect(url) {
            try {
                // Tenta verificar se o protocolo permite navegação padrão
                const protocol = window.location.protocol;
                if (protocol.startsWith('http')) {
                    window.location.href = url;
                } else {
                    // Se for data:, about:, ou file: (com restrição), lança erro ou mostra aviso
                    throw new Error("Navegação direta bloqueada neste ambiente");
                }
            } catch (e) {
                console.warn("Redirecionamento bloqueado (Preview Mode):", e);
                // Oculta o loading
                document.getElementById('loading-screen')?.classList.add('hidden');
                // Mostra overlay de aviso
                document.getElementById('redirect-overlay')?.classList.remove('hidden');
            }
        }

        window.handleLogout = () => {
            signOut(auth).then(() => {
                safeRedirect("login_aluno.html");
            }).catch((error) => {
                console.error("Erro ao sair", error);
            });
        };

        // Date Display
        const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('current-date').innerText = new Date().toLocaleDateString('pt-BR', dateOptions);

        // Auth Listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("Usuário logado:", user.email);
                await loadStudentData(user.email);
            } else {
                // Se não estiver logado, usa redirecionamento seguro
                safeRedirect("login_aluno.html");
            }
        });

        async function loadStudentData(email) {
            try {
                const studentsRef = collection(db, 'artifacts', appId, 'public', 'data', 'students');
                const q = query(studentsRef, where("email", "==", email));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const docData = querySnapshot.docs[0].data();
                    renderDashboard(docData);
                } else {
                    alert("Dados do aluno não encontrados. Entre em contato com a secretaria.");
                    document.getElementById('student-name-display').innerText = "Aluno não vinculado";
                    document.getElementById('loading-screen').classList.add('hidden');
                }
            } catch (error) {
                console.error("Erro ao buscar dados:", error);
                // alert("Erro de conexão com o banco de dados.");
                document.getElementById('loading-screen').classList.add('hidden');
            }
        }

        function renderDashboard(data) {
            document.getElementById('student-name-display').innerText = data.name.split(' ')[0];
            document.getElementById('data-name').innerText = data.name;
            document.getElementById('data-email').innerText = data.email;
            document.getElementById('data-cpf').innerText = data.cpf || '-';
            document.getElementById('data-phone').innerText = data.phone || '-';
            document.getElementById('data-address').innerText = data.address || '-';
            document.getElementById('plan-display').innerText = (data.plan || 'Não informado').replace('-', ' ').toUpperCase();
            
            if(data.contractEndDate) {
                const d = new Date(data.contractEndDate);
                document.getElementById('contract-end').innerText = d.toLocaleDateString('pt-BR');
            }

            const statusBadge = document.getElementById('payment-status-badge');
            const status = data.paymentStatus || 'Pendente';
            statusBadge.innerText = status.toUpperCase();
            
            if(status === 'Em dia') {
                statusBadge.className = "inline-flex items-center px-3 py-1 rounded-full text-xs font-bold mt-2 bg-green-100 text-green-800 border border-green-200";
                statusBadge.innerHTML = '<i class="fa-solid fa-check mr-1"></i> EM DIA';
            } else {
                statusBadge.className = "inline-flex items-center px-3 py-1 rounded-full text-xs font-bold mt-2 bg-red-100 text-red-800 border border-red-200 animate-pulse";
                statusBadge.innerHTML = '<i class="fa-solid fa-triangle-exclamation mr-1"></i> PENDENTE';
            }

            const beltStr = data.belt || "Faixa Branca - 0º Grau";
            document.getElementById('belt-text').innerText = beltStr;
            document.getElementById('belt-visual-container').innerHTML = renderBeltSVG(beltStr);

            setTimeout(() => {
                document.getElementById('loading-screen').classList.add('opacity-0');
                setTimeout(() => {
                    document.getElementById('loading-screen').classList.add('hidden');
                }, 500);
            }, 800);
        }

        function renderBeltSVG(beltStr) {
            if (!beltStr) return '';
            
            const colors = {
                'Branca': '#ffffff', 'Cinza': '#9ca3af', 'Amarela': '#fbbf24', 
                'Laranja': '#f97316', 'Verde': '#10b981', 'Azul': '#3b82f6', 
                'Roxa': '#8b5cf6', 'Marrom': '#78350f', 'Preta': '#000000'
            };

            let color = '#ffffff'; 
            let degree = 0;
            let colorName = 'Branca';

            for (const [name, hex] of Object.entries(colors)) {
                if (beltStr.includes(name)) {
                    color = hex;
                    colorName = name;
                    break;
                }
            }

            const degreeMatch = beltStr.match(/(\d)º/);
            if (degreeMatch) degree = parseInt(degreeMatch[1]);

            const width = 300; 
            const height = 40;
            const tipWidth = 60;
            const stripeWidth = 8;
            const stripeGap = 6;

            let stripesSVG = '';
            const barColor = (colorName === 'Preta') ? '#dc2626' : '#000000';
            const stripeColor = '#ffffff';

            for (let i = 0; i < degree; i++) {
                const x = width - 10 - (i * (stripeWidth + stripeGap)) - stripeWidth;
                stripesSVG += `<rect x="${x}" y="0" width="${stripeWidth}" height="${height}" fill="${stripeColor}" />`;
            }

            const borderStyle = colorName === 'Branca' ? 'stroke="#e5e7eb" stroke-width="2"' : '';

            return `
                <svg width="100%" height="100%" viewBox="0 0 ${width} ${height}" preserveAspectRatio="none">
                    <rect x="0" y="0" width="${width}" height="${height}" fill="${color}" ${borderStyle} />
                    <rect x="${width - tipWidth}" y="0" width="${tipWidth}" height="${height}" fill="${barColor}" />
                    ${stripesSVG}
                </svg>
            `;
        }
    </script>
</body>
</html>
