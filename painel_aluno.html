<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tanque Team | Dashboard Aluno</title>
    
    <link rel="icon" href="https://i.ibb.co/mC2zPJbm/1771300330359.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { red: '#D90429', dark: '#1B1B1B', gray: '#2B2D42', light: '#EDF2F4' }
                    },
                    fontFamily: {
                        sans: ['Roboto', 'sans-serif'],
                        display: ['Oswald', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        .loader {
            border-top-color: #D90429;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .confetti {
            position: absolute;
            width: 10px; height: 10px;
            background-color: #f00;
            animation: confetti-fall 3s linear infinite;
        }
        @keyframes confetti-fall {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(300px) rotate(360deg); opacity: 0; }
        }

        /* Calendar Styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 0.85rem;
            color: #4b5563;
            border: 1px solid transparent;
        }
        .calendar-day.present {
            background-color: #dcfce7; /* green-100 */
            color: #166534; /* green-800 */
            font-weight: bold;
            border-color: #86efac;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .calendar-day.empty {
            background: transparent;
        }
        .calendar-header-day {
            font-size: 0.7rem;
            font-weight: bold;
            text-transform: uppercase;
            color: #9ca3af;
            text-align: center;
            padding-bottom: 4px;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-brand-dark transition-opacity duration-500">
        <div class="text-center">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4 mx-auto"></div>
            <h2 class="text-white font-display text-xl animate-pulse">CARREGANDO DOJO...</h2>
            <p id="loading-text" class="text-gray-400 text-xs mt-2">Sincronizando dados...</p>
        </div>
    </div>

    <!-- Redirect Message Overlay (Hidden by default) -->
    <div id="redirect-overlay" class="fixed inset-0 z-[60] hidden flex flex-col items-center justify-center bg-black/90 text-white p-4 text-center">
        <i class="fa-solid fa-lock text-4xl mb-4 text-brand-red"></i>
        <h2 class="text-xl font-bold mb-2">Acesso Restrito</h2>
        <p class="text-gray-300 mb-6">Voc√™ n√£o est√° logado. Em um site real, voc√™ seria redirecionado.</p>
        <a href="login_aluno.html" class="px-6 py-2 bg-brand-red rounded hover:bg-red-700 transition">Ir para Login (Manual)</a>
    </div>

    <div class="flex h-screen overflow-hidden">
        
        <!-- Sidebar (Desktop) -->
        <aside class="hidden md:flex flex-col w-64 bg-brand-dark text-white shadow-xl z-10">
            <div class="p-6 flex items-center justify-center border-b border-gray-800">
                <img src="https://i.ibb.co/mC2zPJbm/1771300330359.png" alt="Logo" class="h-12 w-auto">
                <span class="ml-3 font-display font-bold text-xl tracking-wider">TANQUE TEAM</span>
            </div>
            <nav class="flex-1 px-4 py-6 space-y-2">
                <a href="#" class="flex items-center px-4 py-3 bg-brand-red text-white rounded-lg shadow-md transition-transform transform hover:translate-x-1">
                    <i class="fa-solid fa-chart-line w-6"></i>
                    <span class="font-bold">Dashboard</span>
                </a>
                <a href="#" class="flex items-center px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition-colors">
                    <i class="fa-solid fa-calendar-check w-6"></i>
                    <span>Presen√ßas</span>
                </a>
                <a href="#" class="flex items-center px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition-colors">
                    <i class="fa-solid fa-file-invoice-dollar w-6"></i>
                    <span>Financeiro</span>
                </a>
                <a href="#" onclick="openProfileEditModal()" class="flex items-center px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition-colors">
                    <i class="fa-solid fa-user-gear w-6"></i>
                    <span>Meus Dados</span>
                </a>
            </nav>
            <div class="p-4 border-t border-gray-800">
                <button onclick="handleLogout()" class="flex items-center w-full px-4 py-2 text-red-400 hover:text-red-300 transition-colors">
                    <i class="fa-solid fa-right-from-bracket w-6"></i>
                    <span>Sair do Sistema</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col h-full overflow-hidden relative">
            
            <!-- Mobile Header -->
            <header class="md:hidden bg-brand-dark text-white p-4 flex justify-between items-center shadow-md z-20">
                <div class="flex items-center">
                    <img src="https://i.ibb.co/mC2zPJbm/1771300330359.png" alt="Logo" class="h-8 w-auto mr-2">
                    <span class="font-display font-bold text-lg">TANQUE TEAM</span>
                </div>
                <button onclick="handleLogout()" class="text-white focus:outline-none">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </button>
            </header>

            <!-- Scrollable Content -->
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-4 md:p-8">
                
                <!-- Welcome Section -->
                <div class="mb-8 flex justify-between items-end">
                    <div>
                        <p class="text-gray-500 text-sm uppercase font-bold tracking-wider mb-1">Bem-vindo de volta,</p>
                        <h1 class="text-3xl md:text-4xl font-display font-bold text-brand-dark" id="student-name-display">Carregando...</h1>
                    </div>
                    <div class="hidden md:block">
                        <span class="bg-white px-4 py-2 rounded-full shadow-sm text-sm font-bold text-gray-600 border border-gray-200">
                            <i class="fa-regular fa-calendar mr-2 text-brand-red"></i> <span id="current-date">--/--/----</span>
                        </span>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    
                    <!-- Left Column (Status & Finance) -->
                    <div class="lg:col-span-2 space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Card 1: Belt Status -->
                            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-brand-red relative overflow-hidden">
                                <div id="celebration-banner" class="hidden absolute top-0 left-0 w-full bg-yellow-400 text-yellow-900 text-center text-xs font-bold py-1 z-10 animate-pulse">
                                    üéâ PARAB√âNS PELA NOVA GRADUA√á√ÉO! üéâ
                                </div>
                                <div class="flex justify-between items-start mb-4 mt-2">
                                    <div>
                                        <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest">Gradua√ß√£o Atual</h3>
                                        <p class="text-xl font-bold text-brand-dark mt-1" id="belt-text">--</p>
                                    </div>
                                    <div class="p-2 bg-gray-50 rounded-lg text-brand-dark">
                                        <i class="fa-solid fa-medal text-xl"></i>
                                    </div>
                                </div>
                                <div id="belt-visual-container" class="w-full h-12 flex items-center justify-center bg-gray-100 rounded border border-gray-200 shadow-inner">
                                    <span class="text-xs text-gray-400">Carregando faixa...</span>
                                </div>
                            </div>

                            <!-- Card 2: Financial Status -->
                            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-gray-800">
                                <div class="flex justify-between items-start mb-4">
                                    <div>
                                        <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest">Financeiro</h3>
                                        <div id="payment-status-badge" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold mt-2 bg-gray-200 text-gray-600">Verificando...</div>
                                    </div>
                                    <div class="p-2 bg-gray-50 rounded-lg text-green-600">
                                        <i class="fa-solid fa-check-circle text-xl"></i>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <p class="text-sm text-gray-600">Plano: <span class="font-bold text-brand-dark" id="plan-display">--</span></p>
                                    <p class="text-xs text-gray-400 mt-1">Vence em: <span id="contract-end">--/--/----</span></p>
                                    <button onclick="viewPaymentHistory()" class="mt-3 text-xs text-blue-600 hover:text-blue-800 font-bold flex items-center">
                                        <i class="fa-solid fa-clock-rotate-left mr-1"></i> Ver Hist√≥rico
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Personal Data Section -->
                        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                            <div class="bg-brand-dark px-6 py-4 border-b border-gray-700 flex justify-between items-center">
                                <h3 class="text-white font-display font-bold tracking-wide">DADOS CADASTRAIS</h3>
                                <button onclick="openProfileEditModal()" class="text-xs text-gray-400 hover:text-white transition"><i class="fa-solid fa-pen-to-square mr-1"></i> Alterar Dados</button>
                            </div>
                            <div class="p-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nome Completo</label><div class="p-3 bg-gray-50 rounded border border-gray-200 text-gray-800 font-medium" id="data-name">--</div></div>
                                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">E-mail</label><div class="p-3 bg-gray-50 rounded border border-gray-200 text-gray-800 font-medium" id="data-email">--</div></div>
                                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">CPF</label><div class="p-3 bg-gray-50 rounded border border-gray-200 text-gray-800 font-medium" id="data-cpf">--</div></div>
                                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Telefone</label><div class="p-3 bg-gray-50 rounded border border-gray-200 text-gray-800 font-medium" id="data-phone">--</div></div>
                                    <div class="md:col-span-2"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Endere√ßo</label><div class="p-3 bg-gray-50 rounded border border-gray-200 text-gray-800 font-medium" id="data-address">--</div></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column (CALENDAR) -->
                    <div class="bg-white rounded-xl shadow-lg p-6 border-t-4 border-blue-500 flex flex-col">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest flex items-center gap-2">
                                <i class="fa-solid fa-calendar-days text-brand-red"></i> Calend√°rio de Treinos
                            </h3>
                            <div class="flex items-center gap-2 bg-gray-100 rounded-full px-2 py-1">
                                <button onclick="changeMonth(-1)" class="w-6 h-6 flex items-center justify-center text-gray-500 hover:bg-white hover:text-brand-red rounded-full transition"><i class="fa-solid fa-chevron-left text-xs"></i></button>
                                <span id="calendar-month-year" class="text-xs font-bold text-brand-dark min-w-[80px] text-center">--</span>
                                <button onclick="changeMonth(1)" class="w-6 h-6 flex items-center justify-center text-gray-500 hover:bg-white hover:text-brand-red rounded-full transition"><i class="fa-solid fa-chevron-right text-xs"></i></button>
                            </div>
                        </div>
                        
                        <!-- Calendar Grid -->
                        <div class="mb-4">
                            <div class="grid grid-cols-7 mb-2">
                                <div class="calendar-header-day">Dom</div><div class="calendar-header-day">Seg</div><div class="calendar-header-day">Ter</div><div class="calendar-header-day">Qua</div><div class="calendar-header-day">Qui</div><div class="calendar-header-day">Sex</div><div class="calendar-header-day">S√°b</div>
                            </div>
                            <div id="calendar-days" class="calendar-grid">
                                <!-- JS Injection -->
                            </div>
                        </div>

                        <!-- Summary -->
                        <div class="mt-auto pt-4 border-t border-gray-100">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-bold text-gray-600">Total de Treinos</span>
                                <span class="text-xl font-bold text-brand-red" id="total-attendance-count">0</span>
                            </div>
                            <div class="text-xs text-gray-400 flex items-center gap-2">
                                <div class="w-3 h-3 bg-green-100 border border-green-300 rounded"></div>
                                <span>Presen√ßa Confirmada</span>
                            </div>
                        </div>
                    </div>

                </div>

                <div class="mt-8 text-center text-xs text-gray-400">
                    &copy; 2026 Tanque Team BJJ. Todos os direitos reservados. Oss.
                </div>
            </main>
        </div>
    </div>

    <!-- Student Edit Profile Modal -->
    <div id="profile-edit-modal" class="fixed inset-0 z-50 hidden bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all">
            <div class="bg-brand-dark px-6 py-4 flex justify-between items-center">
                <h3 class="text-white font-display font-bold text-lg">Alterar Meus Dados</h3>
                <button onclick="closeProfileEditModal()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <div class="p-6">
                <p class="text-xs text-gray-500 mb-4">Atualize suas informa√ß√µes de contato e acesso.</p>
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">E-mail</label>
                        <input type="email" id="profile-email" class="w-full border rounded p-2 text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">Telefone</label>
                        <input type="text" id="profile-phone" class="w-full border rounded p-2 text-sm">
                    </div>
                    <div class="pt-2 border-t border-gray-100">
                        <label class="block text-xs font-bold text-blue-600 mb-1">Nova Senha (Opcional)</label>
                        <input type="text" id="profile-password" class="w-full border border-blue-200 rounded p-2 text-sm" placeholder="Digite para alterar...">
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end gap-2">
                    <button onclick="closeProfileEditModal()" class="px-4 py-2 border rounded text-sm hover:bg-gray-100">Cancelar</button>
                    <button onclick="saveProfileChanges()" class="px-4 py-2 bg-brand-red text-white rounded text-sm hover:bg-red-700 font-bold">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Student History Modal -->
    <div id="student-history-modal" class="fixed inset-0 z-[70] hidden bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md overflow-hidden h-[70vh] flex flex-col">
            <div class="bg-gray-800 px-6 py-4 flex justify-between items-center text-white shrink-0">
                <h3 class="font-bold text-lg"><i class="fa-solid fa-clock-rotate-left mr-2"></i> Meu Hist√≥rico</h3>
                <button onclick="closeStudentHistoryModal()" class="hover:text-gray-300"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="overflow-y-auto p-4 flex-1">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-gray-500 uppercase bg-gray-100 border-b">
                        <tr>
                            <th class="px-3 py-2">Data</th>
                            <th class="px-3 py-2">Valor</th>
                            <th class="px-3 py-2">Forma</th>
                        </tr>
                    </thead>
                    <tbody id="student-history-body" class="divide-y divide-gray-100">
                        <!-- Filled by JS -->
                    </tbody>
                </table>
                <div id="student-history-empty" class="hidden text-center py-8 text-gray-400 italic text-sm">Nenhum pagamento registrado.</div>
            </div>
            <div class="p-4 border-t bg-white shrink-0 text-right">
                <button onclick="closeStudentHistoryModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded text-sm font-bold hover:bg-gray-300">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCWlrrfNn6q4GhhL2H7goHjQMd3MsprxOE",
            authDomain: "tanqueteambjj.firebaseapp.com",
            projectId: "tanqueteambjj",
            storageBucket: "tanqueteambjj.firebasestorage.app",
            messagingSenderId: "410605992451",
            appId: "1:410605992451:web:f0f341f4594fe75f376c36",
            measurementId: "G-SW8PP8X7WM"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const appId = "tanqueteam-bjj";

        window.db = db;
        window.currentStudentData = null; // Store loaded data globally for modals
        
        // Calendar State
        window.currentCalendarDate = new Date(); // To track viewed month

        // --- AUTH & LOAD ---
        window.handleLogout = () => {
            localStorage.removeItem('tanque_user_session');
            window.location.href = "login_aluno.html";
        };

        const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('current-date').innerText = new Date().toLocaleDateString('pt-BR', dateOptions);

        const session = localStorage.getItem('tanque_user_session');
        if (session) {
            try {
                const user = JSON.parse(session);
                if (user && user.id) {
                    loadStudentData(user.id);
                } else {
                    throw new Error("Sess√£o inv√°lida");
                }
            } catch(e) {
                console.error("Erro na sess√£o", e);
                handleLogout();
            }
        } else {
            window.location.href = "login_aluno.html";
        }

        async function loadStudentData(id) {
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'students', id);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const docData = docSnap.data();
                    docData.id = id; // Ensure ID is part of obj
                    window.currentStudentData = docData;
                    renderDashboard(docData);
                } else {
                    alert("Cadastro n√£o encontrado.");
                    document.getElementById('loading-screen').classList.add('hidden');
                }
            } catch (error) {
                console.error("Erro ao buscar dados:", error);
                document.getElementById('loading-screen').classList.add('hidden');
            }
        }

        function renderDashboard(data) {
            document.getElementById('student-name-display').innerText = data.name.split(' ')[0];
            document.getElementById('data-name').innerText = data.name;
            document.getElementById('data-email').innerText = data.email;
            document.getElementById('data-cpf').innerText = data.cpf || '-';
            document.getElementById('data-phone').innerText = data.phone || '-';
            document.getElementById('data-address').innerText = data.address || '-';
            document.getElementById('plan-display').innerText = (data.plan || 'N√£o informado').replace('-', ' ').toUpperCase();
            
            if(data.contractEndDate) {
                const d = new Date(data.contractEndDate);
                document.getElementById('contract-end').innerText = d.toLocaleDateString('pt-BR');
            }

            const statusBadge = document.getElementById('payment-status-badge');
            const status = data.paymentStatus || 'Pendente';
            statusBadge.innerText = status.toUpperCase();
            
            if(status === 'Em dia') {
                statusBadge.className = "inline-flex items-center px-3 py-1 rounded-full text-xs font-bold mt-2 bg-green-100 text-green-800 border border-green-200";
                statusBadge.innerHTML = '<i class="fa-solid fa-check mr-1"></i> EM DIA';
            } else {
                statusBadge.className = "inline-flex items-center px-3 py-1 rounded-full text-xs font-bold mt-2 bg-red-100 text-red-800 border border-red-200 animate-pulse";
                statusBadge.innerHTML = '<i class="fa-solid fa-triangle-exclamation mr-1"></i> PENDENTE';
            }

            // Attendance Count logic
            const attendanceCount = data.attendance ? data.attendance.length : 0;
            document.getElementById('total-attendance-count').innerText = attendanceCount;

            const beltStr = data.belt || "Faixa Branca - 0¬∫ Grau";
            document.getElementById('belt-text').innerText = beltStr;
            document.getElementById('belt-visual-container').innerHTML = renderBeltSVG(beltStr);

            // --- GRADUATION CELEBRATION LOGIC ---
            if(data.lastGraduationDate) {
                const gradDate = new Date(data.lastGraduationDate);
                const today = new Date();
                const diffTime = Math.abs(today - gradDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                
                if(diffDays <= 15) {
                    document.getElementById('celebration-banner').classList.remove('hidden');
                }
            }
            
            // --- RENDER CALENDAR ---
            renderCalendar(data.attendance);

            setTimeout(() => {
                document.getElementById('loading-screen').classList.add('opacity-0');
                setTimeout(() => {
                    document.getElementById('loading-screen').classList.add('hidden');
                }, 500);
            }, 800);
        }

        // --- CALENDAR LOGIC ---
        window.changeMonth = (delta) => {
            window.currentCalendarDate.setMonth(window.currentCalendarDate.getMonth() + delta);
            if (window.currentStudentData) {
                renderCalendar(window.currentStudentData.attendance);
            }
        };

        function renderCalendar(attendanceList) {
            const date = window.currentCalendarDate;
            const year = date.getFullYear();
            const month = date.getMonth();
            
            // Set Header
            const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            document.getElementById('calendar-month-year').innerText = `${monthNames[month]} ${year}`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay(); // 0 (Sun) to 6 (Sat)

            const calendarGrid = document.getElementById('calendar-days');
            calendarGrid.innerHTML = '';

            // Empty slots for previous month
            for (let i = 0; i < startingDay; i++) {
                const div = document.createElement('div');
                div.className = 'calendar-day empty';
                calendarGrid.appendChild(div);
            }

            // Days
            for (let day = 1; day <= daysInMonth; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day hover:bg-gray-50 transition cursor-default';
                dayDiv.innerText = day;

                // Format: YYYY-MM-DD (local time match)
                const m = (month + 1).toString().padStart(2, '0');
                const d = day.toString().padStart(2, '0');
                const dateString = `${year}-${m}-${d}`;

                // Check attendance
                if (attendanceList && attendanceList.includes(dateString)) {
                    dayDiv.classList.add('present');
                    dayDiv.title = "Presen√ßa Confirmada";
                    dayDiv.innerHTML = `${day} <i class="fa-solid fa-check text-[8px] absolute bottom-1 right-1"></i>`;
                    dayDiv.style.position = 'relative';
                }
                
                // Highlight today if in current month
                const today = new Date();
                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                     dayDiv.style.border = '1px solid #D90429';
                     dayDiv.style.fontWeight = 'bold';
                     dayDiv.style.color = '#D90429';
                }

                calendarGrid.appendChild(dayDiv);
            }
        }

        // --- HISTORY MODAL ---
        window.viewPaymentHistory = () => {
            const data = window.currentStudentData;
            if(!data) return;

            const tbody = document.getElementById('student-history-body');
            tbody.innerHTML = '';

            if(!data.paymentHistory || data.paymentHistory.length === 0) {
                document.getElementById('student-history-empty').classList.remove('hidden');
            } else {
                document.getElementById('student-history-empty').classList.add('hidden');
                const sorted = [...data.paymentHistory].sort((a,b) => new Date(b.date) - new Date(a.date));
                sorted.forEach(p => {
                    const row = document.createElement('tr');
                    const d = p.date ? new Date(p.date + 'T12:00:00').toLocaleDateString('pt-BR') : '-';
                    row.innerHTML = `
                        <td class="px-3 py-2 font-medium">${d}</td>
                        <td class="px-3 py-2 text-green-700 font-bold">R$ ${p.amount}</td>
                        <td class="px-3 py-2">${p.method}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
            document.getElementById('student-history-modal').classList.remove('hidden');
            document.getElementById('student-history-modal').classList.add('flex');
        }

        window.closeStudentHistoryModal = () => {
            document.getElementById('student-history-modal').classList.add('hidden');
            document.getElementById('student-history-modal').classList.remove('flex');
        }

        // --- EDIT PROFILE MODAL ---
        window.openProfileEditModal = () => {
            const data = window.currentStudentData;
            if(!data) return;
            document.getElementById('profile-email').value = data.email || '';
            document.getElementById('profile-phone').value = data.phone || '';
            document.getElementById('profile-password').value = ''; // Don't show current password for security/simplicity UI
            
            document.getElementById('profile-edit-modal').classList.remove('hidden');
            document.getElementById('profile-edit-modal').classList.add('flex');
        }

        window.closeProfileEditModal = () => {
            document.getElementById('profile-edit-modal').classList.add('hidden');
            document.getElementById('profile-edit-modal').classList.remove('flex');
        }

        window.saveProfileChanges = async () => {
            const data = window.currentStudentData;
            if(!data) return;

            const newEmail = document.getElementById('profile-email').value;
            const newPhone = document.getElementById('profile-phone').value;
            const newPass = document.getElementById('profile-password').value;

            const updateData = {
                email: newEmail,
                phone: newPhone
            };

            // Only update password if user typed something
            if(newPass && newPass.trim() !== "") {
                updateData.studentPassword = newPass;
            }

            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'students', data.id);
                await updateDoc(docRef, updateData);
                alert("Dados atualizados com sucesso!");
                closeProfileEditModal();
                loadStudentData(data.id); // Reload
            } catch(e) {
                console.error(e);
                alert("Erro ao atualizar dados.");
            }
        }

        function renderBeltSVG(beltStr) {
            if (!beltStr) return '';
            const colors = { 'Branca': '#ffffff', 'Cinza': '#9ca3af', 'Amarela': '#fbbf24', 'Laranja': '#f97316', 'Verde': '#10b981', 'Azul': '#3b82f6', 'Roxa': '#8b5cf6', 'Marrom': '#78350f', 'Preta': '#000000' };
            let color = '#ffffff'; let degree = 0; let colorName = 'Branca';
            for (const [name, hex] of Object.entries(colors)) { if (beltStr.includes(name)) { color = hex; colorName = name; break; } }
            const degreeMatch = beltStr.match(/(\d)¬∫/); if (degreeMatch) degree = parseInt(degreeMatch[1]);
            const width = 300; const height = 40; const tipWidth = 60; const stripeWidth = 8; const stripeGap = 6;
            let stripesSVG = ''; const barColor = (colorName === 'Preta') ? '#dc2626' : '#000000'; const stripeColor = '#ffffff';
            for (let i = 0; i < degree; i++) { const x = width - 10 - (i * (stripeWidth + stripeGap)) - stripeWidth; stripesSVG += `<rect x="${x}" y="0" width="${stripeWidth}" height="${height}" fill="${stripeColor}" />`; }
            const borderStyle = colorName === 'Branca' ? 'stroke="#e5e7eb" stroke-width="2"' : '';
            return `<svg width="100%" height="100%" viewBox="0 0 ${width} ${height}" preserveAspectRatio="none"><rect x="0" y="0" width="${width}" height="${height}" fill="${color}" ${borderStyle} /><rect x="${width - tipWidth}" y="0" width="${tipWidth}" height="${height}" fill="${barColor}" />${stripesSVG}</svg>`;
        }
    </script>
</body>
</html>
