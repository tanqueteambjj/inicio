<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tanque Team | Dashboard Aluno</title>
    
    <link rel="icon" href="https://i.ibb.co/spgfD2Nd/1771300330359.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { red: '#D90429', dark: '#1B1B1B', gray: '#2B2D42', light: '#EDF2F4' }
                    },
                    fontFamily: {
                        sans: ['Roboto', 'sans-serif'],
                        display: ['Oswald', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        .loader {
            border-top-color: #D90429;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-size: 0.85rem; color: #4b5563; border: 1px solid transparent; }
        .calendar-day.present { background-color: #dcfce7; color: #166534; font-weight: bold; border-color: #86efac; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .calendar-day.empty { background: transparent; }
        .calendar-header-day { font-size: 0.7rem; font-weight: bold; text-transform: uppercase; color: #9ca3af; text-align: center; padding-bottom: 4px; }

        /* CSS OTIMIZADO PARA IMPRESS√ÉO ABNT NO PAINEL DO ALUNO */
        @media print {
            @page { margin: 3cm 2cm 2cm 3cm; size: A4 portrait; }
            
            body, html { height: auto !important; min-height: auto !important; overflow: visible !important; background: white !important; }
            
            #main-ui, .no-print, #profile-edit-modal, #student-history-modal { display: none !important; }
            
            #printable-contract { 
                display: block !important; 
                position: relative !important; 
                width: 100% !important; 
                margin: 0 !important; 
                padding: 0 !important; 
                visibility: visible !important; 
            }
            #printable-contract * { visibility: visible !important; }
            
            p { text-align: justify; line-height: 1.5; orphans: 3; widows: 3; margin-bottom: 12px; }
            h1, h2, h3 { page-break-after: avoid; }
            .page-break-inside-avoid { page-break-inside: avoid; }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-brand-dark transition-opacity duration-500">
        <div class="text-center">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4 mx-auto"></div>
            <h2 class="text-white font-display text-xl animate-pulse">CARREGANDO DOJO...</h2>
            <p id="loading-text" class="text-gray-400 text-xs mt-2">Sincronizando dados com o sistema...</p>
        </div>
    </div>

    <!-- Redirect Message Overlay -->
    <div id="redirect-overlay" class="fixed inset-0 z-[60] hidden flex flex-col items-center justify-center bg-black/90 text-white p-4 text-center">
        <i class="fa-solid fa-lock text-4xl mb-4 text-brand-red"></i>
        <h2 class="text-xl font-bold mb-2">Acesso Restrito</h2>
        <p class="text-gray-300 mb-6">Voc√™ n√£o est√° logado. Por favor, fa√ßa o login novamente.</p>
        <a href="login_aluno.html" class="px-6 py-2 bg-brand-red rounded hover:bg-red-700 transition font-bold">Ir para Login</a>
    </div>

    <!-- Main UI Wrapped for Easy Hiding During Print -->
    <div id="main-ui" class="flex h-screen overflow-hidden">
        
        <!-- Sidebar (Desktop) -->
        <aside class="hidden md:flex flex-col w-64 bg-brand-dark text-white shadow-xl z-10 no-print">
            <div class="p-6 flex items-center justify-center border-b border-gray-800">
                <img src="https://i.ibb.co/spgfD2Nd/1771300330359.png" alt="Logo" class="h-12 w-auto">
                <span class="ml-3 font-display font-bold text-xl tracking-wider">TANQUE TEAM</span>
            </div>
            <nav class="flex-1 px-4 py-6 space-y-2">
                <a href="#" class="flex items-center px-4 py-3 bg-brand-red text-white rounded-lg shadow-md transition-transform transform hover:translate-x-1">
                    <i class="fa-solid fa-chart-line w-6"></i>
                    <span class="font-bold">Dashboard</span>
                </a>
                 <a href="#" onclick="openProfileEditModal()" class="flex items-center px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition-colors">
                    <i class="fa-solid fa-user-gear w-6"></i>
                    <span>Meus Dados</span>
                </a>
            </nav>
            <div class="p-4 border-t border-gray-800">
                <button onclick="handleLogout()" class="flex items-center w-full px-4 py-2 text-red-400 hover:text-red-300 transition-colors">
                    <i class="fa-solid fa-right-from-bracket w-6"></i>
                    <span>Sair do Sistema</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col h-full overflow-hidden relative">
            
            <!-- Mobile Header -->
            <header class="md:hidden bg-brand-dark text-white p-4 flex justify-between items-center shadow-md z-20 no-print">
                <div class="flex items-center">
                    <img src="https://i.ibb.co/spgfD2Nd/1771300330359.png" alt="Logo" class="h-8 w-auto mr-2">
                    <span class="font-display font-bold text-lg">TANQUE TEAM</span>
                </div>
                <button onclick="handleLogout()" class="text-white focus:outline-none">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </button>
            </header>

            <!-- DEPENDENT VIEW BANNER -->
            <div id="viewing-dependent-banner" class="hidden bg-purple-600 text-white px-4 py-3 flex justify-between items-center shadow-md z-20 no-print">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-users text-purple-200"></i>
                    <span class="text-sm">Gerenciando dependente: <strong id="viewing-dependent-name">Nome</strong></span>
                </div>
                <button onclick="switchToTitular()" class="bg-white text-purple-700 hover:bg-gray-100 px-3 py-1.5 rounded text-xs font-bold transition shadow-sm">
                    <i class="fa-solid fa-arrow-left mr-1 hidden sm:inline"></i> Voltar<span class="hidden sm:inline"> ao Titular</span>
                </button>
            </div>

            <!-- Scrollable Content -->
            <main id="student-dashboard" class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-4 md:p-8">
                
                <!-- Welcome Section -->
                <div class="mb-8 flex justify-between items-end">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 rounded-full bg-gray-200 border-2 border-white shadow-md overflow-hidden flex-shrink-0">
                            <img id="welcome-photo" src="" class="w-full h-full object-cover hidden">
                            <div id="welcome-initials" class="w-full h-full flex items-center justify-center text-gray-500 text-2xl font-bold font-display">TT</div>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm uppercase font-bold tracking-wider mb-1">Bem-vindo(a) de volta,</p>
                            <div class="flex items-center gap-3">
                                <h1 class="text-3xl md:text-4xl font-display font-bold text-brand-dark" id="student-name-display">Carregando...</h1>
                                <span id="enrollment-status-badge" class="hidden px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider text-white shadow-sm transform -translate-y-1"></span>
                            </div>
                        </div>
                    </div>
                    <div class="hidden md:block">
                        <span class="bg-white px-4 py-2 rounded-full shadow-sm text-sm font-bold text-gray-600 border border-gray-200">
                            <i class="fa-regular fa-calendar mr-2 text-brand-red"></i> <span id="current-date">--/--/----</span>
                        </span>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    
                    <!-- Left Column (Status & Finance) -->
                    <div class="lg:col-span-2 space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Card 1: Belt Status -->
                            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-brand-red relative overflow-hidden">
                                <div id="celebration-banner" class="hidden absolute top-0 left-0 w-full bg-yellow-400 text-yellow-900 text-center text-xs font-bold py-1 z-10 animate-pulse">
                                    üéâ PARAB√âNS PELA NOVA GRADUA√á√ÉO! üéâ
                                </div>
                                <div class="flex justify-between items-start mb-4 mt-2">
                                    <div>
                                        <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest">Gradua√ß√£o Atual</h3>
                                        <p class="text-xl font-bold text-brand-dark mt-1" id="belt-text">--</p>
                                    </div>
                                    <div class="p-2 bg-gray-50 rounded-lg text-brand-dark">
                                        <i class="fa-solid fa-medal text-xl"></i>
                                    </div>
                                </div>
                                <div id="belt-visual-container" class="w-full h-12 flex items-center justify-center bg-gray-100 rounded border border-gray-200 shadow-inner">
                                    <span class="text-xs text-gray-400">Carregando faixa...</span>
                                </div>
                            </div>

                            <!-- Card 2: Financial Status -->
                            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-gray-800">
                                <div class="flex justify-between items-start mb-4">
                                    <div>
                                        <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest">Financeiro</h3>
                                        <div id="payment-status-badge" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold mt-2 bg-gray-200 text-gray-600">Verificando...</div>
                                    </div>
                                    <div class="p-2 bg-gray-50 rounded-lg text-green-600">
                                        <i class="fa-solid fa-check-circle text-xl"></i>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <p class="text-sm text-gray-600">Plano: <span class="font-bold text-brand-dark" id="plan-display">--</span></p>
                                    <p class="text-xs text-gray-400 mt-1">Vence em: <span id="contract-end">--/--/----</span></p>
                                    <button onclick="viewPaymentHistory()" class="mt-3 text-xs text-blue-600 hover:text-blue-800 font-bold flex items-center">
                                        <i class="fa-solid fa-clock-rotate-left mr-1"></i> Ver Hist√≥rico Financeiro
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Personal Data Section -->
                        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                            <div class="bg-brand-dark px-6 py-4 border-b border-gray-700 flex justify-between items-center">
                                <h3 class="text-white font-display font-bold tracking-wide">DADOS CADASTRAIS</h3>
                                <button onclick="openProfileEditModal()" class="text-xs text-gray-400 hover:text-white transition"><i class="fa-solid fa-pen-to-square mr-1"></i> Alterar Dados</button>
                            </div>
                            <div class="p-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nome Completo</label><div class="p-3 bg-gray-50 rounded border border-gray-200 text-gray-800 font-medium" id="data-name">--</div></div>
                                    
                                    <div>
                                        <label class="block text-xs font-bold text-blue-600 uppercase mb-1">Usu√°rio de Acesso (Login)</label>
                                        <div class="p-3 bg-blue-50 rounded border border-blue-100 text-blue-900 font-bold" id="data-login">--</div>
                                    </div>

                                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">E-mail</label><div class="p-3 bg-gray-50 rounded border border-gray-200 text-gray-800 font-medium" id="data-email">--</div></div>
                                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">CPF</label><div class="p-3 bg-gray-50 rounded border border-gray-200 text-gray-800 font-medium" id="data-cpf">--</div></div>
                                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Telefone</label><div class="p-3 bg-gray-50 rounded border border-gray-200 text-gray-800 font-medium" id="data-phone">--</div></div>
                                    <div class="md:col-span-2"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Endere√ßo</label><div class="p-3 bg-gray-50 rounded border border-gray-200 text-gray-800 font-medium" id="data-address">--</div></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column (CALENDAR) -->
                    <div class="bg-white rounded-xl shadow-lg p-6 border-t-4 border-blue-500 flex flex-col">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest flex items-center gap-2">
                                <i class="fa-solid fa-calendar-days text-brand-red"></i> Calend√°rio de Treinos
                            </h3>
                            <div class="flex items-center gap-2 bg-gray-100 rounded-full px-2 py-1">
                                <button onclick="changeMonth(-1)" class="w-6 h-6 flex items-center justify-center text-gray-500 hover:bg-white hover:text-brand-red rounded-full transition"><i class="fa-solid fa-chevron-left text-xs"></i></button>
                                <span id="calendar-month-year" class="text-xs font-bold text-brand-dark min-w-[80px] text-center">--</span>
                                <button onclick="changeMonth(1)" class="w-6 h-6 flex items-center justify-center text-gray-500 hover:bg-white hover:text-brand-red rounded-full transition"><i class="fa-solid fa-chevron-right text-xs"></i></button>
                            </div>
                        </div>
                        
                        <!-- Calendar Grid -->
                        <div class="mb-4">
                            <div class="grid grid-cols-7 mb-2">
                                <div class="calendar-header-day">Dom</div><div class="calendar-header-day">Seg</div><div class="calendar-header-day">Ter</div><div class="calendar-header-day">Qua</div><div class="calendar-header-day">Qui</div><div class="calendar-header-day">Sex</div><div class="calendar-header-day">S√°b</div>
                            </div>
                            <div id="calendar-days" class="calendar-grid">
                                <!-- JS Injection -->
                            </div>
                        </div>

                        <!-- Summary -->
                        <div class="mt-auto pt-4 border-t border-gray-100">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-bold text-gray-600">Total de Treinos</span>
                                <span class="text-xl font-bold text-brand-red" id="total-attendance-count">0</span>
                            </div>
                            <div class="text-xs text-gray-400 flex items-center gap-2">
                                <div class="w-3 h-3 bg-green-100 border border-green-300 rounded"></div>
                                <span>Presen√ßa Confirmada</span>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Dependentes Vinculados -->
                <div id="dash-dependents-container" class="hidden mt-6 bg-white rounded-xl shadow-lg p-6 text-left border-l-4 border-purple-500 mb-8">
                    <h3 class="font-display text-xl font-bold text-gray-700 mb-3 flex items-center gap-2"><i class="fa-solid fa-users text-purple-600"></i> Meus Dependentes (Combo Fam√≠lia)</h3>
                    <p class="text-xs text-gray-500 mb-4">Gerencie as informa√ß√µes e acompanhe a frequ√™ncia de quem treina junto com voc√™ no plano Combo.</p>
                    <div id="dash-dependents-list" class="space-y-3">
                        <!-- Filled by JS -->
                    </div>
                </div>
                
                <button onclick="printStudentContract()" class="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg flex justify-center items-center gap-2 mb-6 transition transform hover:-translate-y-1">
                    <i class="fa-solid fa-file-contract text-xl"></i> Imprimir Minha Matr√≠cula / Contrato
                </button>

                <div class="mt-8 text-center text-xs text-gray-400">
                    &copy; 2026 Tanque Team BJJ. Todos os direitos reservados. Oss.
                </div>
            </main>
        </div>
    </div> <!-- End Main UI -->

    <!-- Printable Contract Container for Student (Fora do Main UI) -->
    <div id="printable-contract" class="hidden font-serif text-[11pt] leading-relaxed">
        <div class="header-section text-center mb-6 border-b-2 border-black pb-4">
            <h1 class="text-2xl font-bold uppercase tracking-wider mb-1">Tanque Team BJJ</h1>
            <p class="text-xs">CNPJ: 00.000.000/0001-00</p>
            <p class="text-xs">Rua Jos√© Custodio de Almeida, N¬∫ 9 - Parque Verde - Bel√©m-PA, CEP 66635-110</p>
            <p class="text-xs">Tel: (91) 99819-2610 | Email: contato@tanqueteambjj.com</p>
        </div>
        <h2 class="text-center font-bold text-lg mb-6 uppercase underline tracking-wide">Contrato de Presta√ß√£o de Servi√ßos Esportivos</h2>
        
        <div class="parties-section mb-6 text-sm text-justify space-y-2 bg-gray-50 p-4 border border-gray-200 rounded">
            <p><strong>1. CONTRATADA:</strong> <span class="uppercase font-bold">Tanque Team Academia de Artes Marciais LTDA</span>, inscrita no CNPJ sob o n¬∫ 00.000.000/0001-00.</p>
            <p><strong>2. CONTRATANTE (Respons√°vel Financeiro):</strong> <span id="printContratante" class="font-bold uppercase"></span>, inscrito(a) no CPF sob o n¬∫ <span id="printCPF" class="font-mono font-bold"></span>, residente e domiciliado(a) em <span id="printAddress" class="uppercase"></span>, Telefone: <span id="printPhone"></span>, E-mail: <span id="printEmail"></span>.</p>
            <p><strong>3. ALUNO(A) PRINCIPAL:</strong> <span id="printStudent" class="font-bold uppercase"></span>, nascido(a) em <span id="printDob" class="font-mono"></span>. <span id="printBeltInfo"></span></p>
            <div id="printDependentsBlock" class="mt-2 pl-4 border-l-2 border-gray-400"></div>
        </div>

        <div id="print-clauses-container" class="clauses-section text-sm text-justify mb-6 space-y-3">
            <!-- JS Injected Clauses -->
        </div>

        <div class="signatures-section mt-12 page-break-inside-avoid">
            <p class="mb-8 text-right text-sm">Bel√©m-PA, <span id="printContractDate"></span>.</p>
            <div class="flex justify-between gap-8 mt-12">
                <div class="w-1/2 text-center">
                    <div class="border-t border-black pt-2 mx-4">
                        <p class="font-bold text-lg signature-font mb-1" style="font-family: cursive;">Tanque Team BJJ</p>
                        <p class="font-bold uppercase text-[10px] tracking-wider">CONTRATADA (Representante Legal)</p>
                    </div>
                </div>
                <div class="w-1/2 text-center">
                    <div class="border-t border-black pt-2 mx-4">
                        <p class="font-bold text-sm mb-1 text-green-700 h-7 flex items-center justify-center"><i class="fa-solid fa-check-circle mr-1"></i> Aceite Eletr√¥nico Registrado</p>
                        <p class="font-bold uppercase text-[10px] tracking-wider" id="printSignatureName"></p>
                        <p class="text-[8px] text-gray-500">Validade jur√≠dica assegurada pela MP n¬∫ 2.200-2/2001</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Edit Profile Modal -->
    <div id="profile-edit-modal" class="fixed inset-0 z-50 hidden bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all">
            <div class="bg-brand-dark px-6 py-4 flex justify-between items-center">
                <h3 class="text-white font-display font-bold text-lg">Alterar Dados</h3>
                <button onclick="closeProfileEditModal()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <div class="p-6">
                <!-- PHOTO UPLOAD SECTION -->
                <div class="flex items-center gap-4 mb-6 border-b pb-4 border-gray-100">
                    <div class="relative w-20 h-20 group cursor-pointer flex-shrink-0" onclick="document.getElementById('profile-photo-input').click()">
                        <img id="profile-photo-preview" src="" class="w-full h-full rounded-full object-cover border-2 border-gray-200 shadow-md hidden">
                        <div id="profile-photo-placeholder" class="w-full h-full bg-gray-200 rounded-full flex items-center justify-center text-2xl font-bold text-gray-400">TT</div>
                        <div class="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                            <i class="fa-solid fa-camera text-white"></i>
                        </div>
                        <input type="file" id="profile-photo-input" accept="image/*" class="hidden" onchange="previewProfilePhoto(event)">
                    </div>
                    <div>
                        <h4 class="text-xs font-bold text-brand-red uppercase">Foto de Perfil</h4>
                        <p class="text-[10px] text-gray-400">Clique na imagem para enviar uma nova foto.</p>
                    </div>
                </div>

                <div class="space-y-3">
                    <div id="profile-login-container">
                        <label class="block text-xs font-bold text-gray-500 mb-1">Usu√°rio (Login)</label>
                        <input type="text" id="profile-login" class="w-full border rounded p-2 text-sm bg-gray-100 text-gray-500" disabled>
                        <p class="text-[10px] text-gray-400">Este √© seu login √∫nico. N√£o pode ser alterado.</p>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">Endere√ßo</label>
                        <input type="text" id="profile-address" class="w-full border rounded p-2 text-sm">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">E-mail</label>
                            <input type="email" id="profile-email" class="w-full border rounded p-2 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Telefone</label>
                            <input type="text" id="profile-phone" class="w-full border rounded p-2 text-sm">
                        </div>
                    </div>
                    <div class="pt-2 border-t border-gray-100" id="profile-password-container">
                        <label class="block text-xs font-bold text-blue-600 mb-1">Nova Senha (Opcional)</label>
                        <input type="text" id="profile-password" class="w-full border border-blue-200 rounded p-2 text-sm" placeholder="Digite para alterar...">
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end gap-2">
                    <button onclick="closeProfileEditModal()" class="px-4 py-2 border rounded text-sm hover:bg-gray-100">Cancelar</button>
                    <button onclick="saveProfileChanges()" class="px-4 py-2 bg-brand-red text-white rounded text-sm hover:bg-red-700 font-bold">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Student History Modal -->
    <div id="student-history-modal" class="fixed inset-0 z-[70] hidden bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md overflow-hidden h-[70vh] flex flex-col">
            <div class="bg-gray-800 px-6 py-4 flex justify-between items-center text-white shrink-0">
                <h3 class="font-bold text-lg"><i class="fa-solid fa-clock-rotate-left mr-2"></i> Meu Hist√≥rico</h3>
                <button onclick="closeStudentHistoryModal()" class="hover:text-gray-300"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="overflow-y-auto p-4 flex-1">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-gray-500 uppercase bg-gray-100 border-b">
                        <tr>
                            <th class="px-3 py-2">Data</th>
                            <th class="px-3 py-2">Valor</th>
                            <th class="px-3 py-2">Forma</th>
                        </tr>
                    </thead>
                    <tbody id="student-history-body" class="divide-y divide-gray-100">
                        <!-- Filled by JS -->
                    </tbody>
                </table>
                <div id="student-history-empty" class="hidden text-center py-8 text-gray-400 italic text-sm">Nenhum pagamento registrado.</div>
            </div>
            <div class="p-4 border-t bg-white shrink-0 text-right">
                <button onclick="closeStudentHistoryModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded text-sm font-bold hover:bg-gray-300">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, getDocs, collection, query, where, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCWlrrfNn6q4GhhL2H7goHjQMd3MsprxOE",
            authDomain: "tanqueteambjj.firebaseapp.com",
            projectId: "tanqueteambjj",
            storageBucket: "tanqueteambjj.firebasestorage.app",
            messagingSenderId: "410605992451",
            appId: "1:410605992451:web:f0f341f4594fe75f376c36",
            measurementId: "G-SW8PP8X7WM"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "tanqueteam-bjj";

        window.db = db;
        window.titularData = null; // Armazena a conta principal autenticada
        window.currentStudentData = null; // Armazena quem est√° sendo visto no momento
        window.currentCalendarDate = new Date(); 

        window.handleLogout = () => {
            localStorage.removeItem('tanque_user_session');
            window.location.href = "login_aluno.html";
        };

        const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('current-date').innerText = new Date().toLocaleDateString('pt-BR', dateOptions);

        const session = localStorage.getItem('tanque_user_session');
        if (session) {
            try {
                const user = JSON.parse(session);
                if (user && user.id) {
                    // AUTHENTICATE FIRST
                    const initAuth = async () => {
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                            // Only load data after Auth resolves
                            window.loadStudentData(user.id);
                        } catch (e) {
                            console.error("Erro na autentica√ß√£o Firebase:", e);
                            document.getElementById('loading-screen').classList.add('hidden');
                            document.getElementById('redirect-overlay').classList.remove('hidden');
                        }
                    };
                    initAuth();

                } else {
                    throw new Error("Sess√£o inv√°lida");
                }
            } catch(e) {
                console.error("Erro na sess√£o", e);
                window.handleLogout();
            }
        } else {
            window.location.href = "login_aluno.html";
        }

        window.loadStudentData = async function(id) {
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'students', id);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const docData = docSnap.data();
                    docData.id = id; 
                    
                    // Buscar dependentes vinculados
                    const qDeps = query(
                        collection(db, 'artifacts', appId, 'public', 'data', 'students'),
                        where('titularId', '==', docData.id)
                    );
                    const depSnap = await getDocs(qDeps);
                    docData.dependentsList = [];
                    depSnap.forEach(d => {
                        let dep = d.data();
                        dep.id = d.id;
                        docData.dependentsList.push(dep);
                    });

                    window.titularData = docData;
                    window.currentStudentData = docData;
                    renderDashboard(docData, false);
                } else {
                    document.getElementById('loading-screen').classList.add('hidden');
                    document.getElementById('redirect-overlay').classList.remove('hidden');
                }
            } catch (error) {
                console.error("Erro ao buscar dados:", error);
                document.getElementById('loading-screen').classList.add('hidden');
            }
        }

        function renderDashboard(data, isDependent = false) {
            try {
                const safeName = data.name || "Aluno";
                document.getElementById('student-name-display').innerText = safeName.split(' ')[0];
                
                const enrollmentStatus = data.enrollmentStatus || 'Ativo';
                const badge = document.getElementById('enrollment-status-badge');
                badge.innerText = enrollmentStatus;
                badge.classList.remove('hidden');
                if (enrollmentStatus === 'Ativo') {
                    badge.classList.add('bg-green-500');
                    badge.classList.remove('bg-red-500');
                } else {
                    badge.classList.add('bg-red-500');
                    badge.classList.remove('bg-green-500');
                }

                document.getElementById('data-name').innerText = safeName;
                document.getElementById('data-login').innerText = data.studentLogin || (isDependent ? 'Acesso via Titular' : 'N√£o definido');
                document.getElementById('data-email').innerText = data.email || 'N√£o informado';
                document.getElementById('data-cpf').innerText = data.cpf || '-';
                document.getElementById('data-phone').innerText = data.phone || '-';
                document.getElementById('data-address').innerText = data.address || '-';

                let displayName = 'N√ÉO INFORMADO';
                if(data.plan) {
                    if(data.plan === 'combo-dupla') displayName = 'COMBO DUPLA';
                    else if(data.plan === 'combo-casal') displayName = 'COMBO CASAL';
                    else if(data.plan === 'combo-familia') displayName = 'COMBO FAM√çLIA';
                    else if(data.plan === 'dependente') displayName = 'DEPENDENTE - COMBO FAM√çLIA';
                    else displayName = data.plan.replace('infantil-', 'Infantil ').replace('adulto-', 'Jovem/Adulto ').replace('mensal', 'Mensal').replace('trimestral', 'Trimestral').replace('semestral', 'Semestral').toUpperCase();
                }
                document.getElementById('plan-display').innerText = displayName;
                
                // Photo Display
                const photoImg = document.getElementById('welcome-photo');
                const photoInitials = document.getElementById('welcome-initials');
                
                if(data.photoBase64) {
                    photoImg.src = data.photoBase64;
                    photoImg.classList.remove('hidden');
                    photoInitials.classList.add('hidden');
                } else {
                    photoImg.classList.add('hidden');
                    photoInitials.classList.remove('hidden');
                    photoInitials.innerText = safeName.charAt(0).toUpperCase();
                }

                if(data.contractEndDate) {
                    const d = new Date(data.contractEndDate);
                    if(!isNaN(d)) {
                        document.getElementById('contract-end').innerText = d.toLocaleDateString('pt-BR');
                    }
                }

                const statusBadge = document.getElementById('payment-status-badge');
                const status = data.paymentStatus || 'Pendente';
                statusBadge.innerText = status.toUpperCase();
                
                if(status === 'Em dia') {
                    statusBadge.className = "inline-flex items-center px-3 py-1 rounded-full text-xs font-bold mt-2 bg-green-100 text-green-800 border border-green-200";
                    statusBadge.innerHTML = '<i class="fa-solid fa-check mr-1"></i> EM DIA';
                } else if(status === 'Isento') {
                    statusBadge.className = "inline-flex items-center px-3 py-1 rounded-full text-xs font-bold mt-2 bg-blue-100 text-blue-800 border border-blue-200";
                    statusBadge.innerHTML = '<i class="fa-solid fa-gift mr-1"></i> ISENTO';
                } else {
                    statusBadge.className = "inline-flex items-center px-3 py-1 rounded-full text-xs font-bold mt-2 bg-red-100 text-red-800 border border-red-200 animate-pulse";
                    statusBadge.innerHTML = '<i class="fa-solid fa-triangle-exclamation mr-1"></i> PENDENTE';
                }

                const attendanceCount = data.attendance ? data.attendance.length : 0;
                document.getElementById('total-attendance-count').innerText = attendanceCount;

                const beltStr = data.belt || "Faixa Branca - 0¬∫ Grau";
                document.getElementById('belt-text').innerText = beltStr;
                document.getElementById('belt-visual-container').innerHTML = renderBeltSVG(beltStr);

                // Graduation celebration logic
                const celBanner = document.getElementById('celebration-banner');
                if(data.lastGraduationDate) {
                    const gradDate = new Date(data.lastGraduationDate);
                    const today = new Date();
                    const diffTime = Math.abs(today - gradDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                    if(diffDays <= 15) celBanner.classList.remove('hidden');
                    else celBanner.classList.add('hidden');
                } else {
                    celBanner.classList.add('hidden');
                }
                
                // Calendar
                renderCalendar(data.attendance);

                // DUAL PROFILE LOGIC (Titular vs Dependent)
                const depBanner = document.getElementById('viewing-dependent-banner');
                if (isDependent) {
                    depBanner.classList.remove('hidden');
                    document.getElementById('viewing-dependent-name').innerText = safeName;
                } else {
                    depBanner.classList.add('hidden');
                }

                const depContainer = document.getElementById('dash-dependents-container');
                if (!isDependent && window.titularData && window.titularData.dependentsList && window.titularData.dependentsList.length > 0) {
                    depContainer.classList.remove('hidden');
                    let depHtml = '';
                    window.titularData.dependentsList.forEach(dep => {
                        depHtml += `
                        <div class="bg-purple-50 border border-purple-200 rounded p-4 flex justify-between items-center shadow-sm">
                            <div>
                                <p class="font-bold text-sm text-purple-900">${dep.name}</p>
                                <p class="text-xs text-purple-700">${dep.parentesco || 'Dependente'} ‚Ä¢ ${dep.belt || 'Faixa Branca'}</p>
                            </div>
                            <button onclick="switchToDependent('${dep.id}')" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded text-xs font-bold transition shadow">
                                <i class="fa-solid fa-user-gear mr-1"></i> Gerenciar Aluno
                            </button>
                        </div>`;
                    });
                    document.getElementById('dash-dependents-list').innerHTML = depHtml;
                } else {
                    if(depContainer) depContainer.classList.add('hidden');
                }
            } catch (err) {
                console.error("Erro interno ao renderizar Dashboard:", err);
            } finally {
                // FORCE LOADER TO HIDE NO MATTER WHAT
                const loader = document.getElementById('loading-screen');
                if (loader) {
                    loader.classList.add('opacity-0');
                    setTimeout(() => {
                        loader.classList.add('hidden');
                    }, 500);
                }
            }
        }

        window.switchToDependent = (depId) => {
            const dep = window.titularData.dependentsList.find(d => d.id === depId);
            if (dep) {
                window.currentStudentData = dep;
                renderDashboard(dep, true);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };

        window.switchToTitular = () => {
            window.currentStudentData = window.titularData;
            renderDashboard(window.titularData, false);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        // --- CALENDAR LOGIC ---
        window.changeMonth = (delta) => {
            window.currentCalendarDate.setMonth(window.currentCalendarDate.getMonth() + delta);
            if (window.currentStudentData) {
                renderCalendar(window.currentStudentData.attendance);
            }
        };

        function renderCalendar(attendanceList) {
            const date = window.currentCalendarDate;
            const year = date.getFullYear();
            const month = date.getMonth();
            
            const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            document.getElementById('calendar-month-year').innerText = `${monthNames[month]} ${year}`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay(); 

            const calendarGrid = document.getElementById('calendar-days');
            calendarGrid.innerHTML = '';

            for (let i = 0; i < startingDay; i++) {
                const div = document.createElement('div');
                div.className = 'calendar-day empty';
                calendarGrid.appendChild(div);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day hover:bg-gray-50 transition cursor-default';
                dayDiv.innerText = day;

                const m = (month + 1).toString().padStart(2, '0');
                const d = day.toString().padStart(2, '0');
                const dateString = `${year}-${m}-${d}`;

                if (attendanceList && attendanceList.includes(dateString)) {
                    dayDiv.classList.add('present');
                    dayDiv.title = "Presen√ßa Confirmada";
                    dayDiv.innerHTML = `${day} <i class="fa-solid fa-check text-[8px] absolute bottom-1 right-1"></i>`;
                    dayDiv.style.position = 'relative';
                }
                
                const today = new Date();
                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                     dayDiv.style.border = '1px solid #D90429';
                     dayDiv.style.fontWeight = 'bold';
                     dayDiv.style.color = '#D90429';
                }

                calendarGrid.appendChild(dayDiv);
            }
        }

        window.viewPaymentHistory = () => {
            const data = window.currentStudentData;
            if(!data) return;

            const tbody = document.getElementById('student-history-body');
            tbody.innerHTML = '';

            if(!data.paymentHistory || data.paymentHistory.length === 0) {
                document.getElementById('student-history-empty').classList.remove('hidden');
            } else {
                document.getElementById('student-history-empty').classList.add('hidden');
                const sorted = [...data.paymentHistory].sort((a,b) => new Date(b.date) - new Date(a.date));
                sorted.forEach(p => {
                    const row = document.createElement('tr');
                    const d = p.date ? new Date(p.date + 'T12:00:00').toLocaleDateString('pt-BR') : '-';
                    row.innerHTML = `
                        <td class="px-3 py-2 font-medium">${d}</td>
                        <td class="px-3 py-2 text-green-700 font-bold">R$ ${p.amount}</td>
                        <td class="px-3 py-2">${p.method}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
            document.getElementById('student-history-modal').classList.remove('hidden');
            document.getElementById('student-history-modal').classList.add('flex');
        }

        window.closeStudentHistoryModal = () => {
            document.getElementById('student-history-modal').classList.add('hidden');
            document.getElementById('student-history-modal').classList.remove('flex');
        }

        window.openProfileEditModal = () => {
            const data = window.currentStudentData;
            if(!data) return;
            
            // Oculta campos de senha e login para dependentes (apenas titular tem acesso direto)
            const isDep = data.plan === 'dependente';
            document.getElementById('profile-login-container').classList.toggle('hidden', isDep);
            document.getElementById('profile-password-container').classList.toggle('hidden', isDep);

            document.getElementById('profile-email').value = data.email || '';
            document.getElementById('profile-phone').value = data.phone || '';
            document.getElementById('profile-address').value = data.address || '';
            document.getElementById('profile-login').value = data.studentLogin || 'N√£o definido'; 
            document.getElementById('profile-password').value = ''; 
            
            const preview = document.getElementById('profile-photo-preview');
            const placeholder = document.getElementById('profile-photo-placeholder');
            if(data.photoBase64) {
                 preview.src = data.photoBase64;
                 preview.classList.remove('hidden');
                 placeholder.classList.add('hidden');
            } else {
                 preview.classList.add('hidden');
                 placeholder.classList.remove('hidden');
                 placeholder.innerText = (data.name || '?').charAt(0).toUpperCase();
            }
            
            document.getElementById('profile-edit-modal').classList.remove('hidden');
            document.getElementById('profile-edit-modal').classList.add('flex');
        }

        window.closeProfileEditModal = () => {
            document.getElementById('profile-edit-modal').classList.add('hidden');
            document.getElementById('profile-edit-modal').classList.remove('flex');
        }
        
        window.previewProfilePhoto = (event) => {
            const file = event.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('profile-photo-preview');
                    const placeholder = document.getElementById('profile-photo-placeholder');
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                }
                reader.readAsDataURL(file);
            }
        };

        window.saveProfileChanges = async () => {
            const data = window.currentStudentData;
            if(!data) return;

            const newEmail = document.getElementById('profile-email').value;
            const newPhone = document.getElementById('profile-phone').value;
            const newAddress = document.getElementById('profile-address').value;
            const newPass = document.getElementById('profile-password').value;

            const updateData = {
                email: newEmail,
                phone: newPhone,
                address: newAddress
            };

            if(!document.getElementById('profile-password-container').classList.contains('hidden') && newPass && newPass.trim() !== "") {
                updateData.studentPassword = newPass;
            }
            
            const photoInput = document.getElementById('profile-photo-input');
            let photoBase64 = null;
            
            if(photoInput.files && photoInput.files[0]) {
                 const file = photoInput.files[0];
                 if(file.size > 800 * 1024) { 
                      alert("A foto √© muito grande. Por favor, use uma imagem menor que 800KB.");
                      return;
                 }
                 photoBase64 = await new Promise((resolve) => {
                      const reader = new FileReader();
                      reader.onloadend = () => resolve(reader.result);
                      reader.readAsDataURL(file);
                 });
                 updateData.photoBase64 = photoBase64;
            }

            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'students', data.id);
                await updateDoc(docRef, updateData);
                alert("Dados atualizados com sucesso!");
                closeProfileEditModal();
                // Reloads full data to maintain logic
                loadStudentData(window.titularData.id); 
            } catch(e) {
                console.error(e);
                alert("Erro ao atualizar dados.");
            }
        }

        window.populateContractDOM = function(s) {
            let price = "R$ 0,00";
            if(s.plan === 'infantil-mensal') price = "R$ 189,90";
            else if(s.plan === 'infantil-trimestral') price = "R$ 168,90";
            else if(s.plan === 'infantil-semestral') price = "R$ 157,90";
            else if(s.plan === 'adulto-mensal') price = "R$ 168,90";
            else if(s.plan === 'adulto-trimestral') price = "R$ 147,90";
            else if(s.plan === 'adulto-semestral') price = "R$ 126,90";
            else if(s.plan === 'combo-dupla') price = "R$ 250,00";
            else if(s.plan === 'combo-familia') price = "R$ 362,02";
            
            let promoNote = "";
            if (s.plan && s.plan.includes('semestral') && !s.plan.includes('combo')) {
                promoNote = "OBS: Promo√ß√£o de Inaugura√ß√£o aplicada. A 1¬™ Mensalidade ter√° o valor reduzido de R$ 29,90.";
            } else if (s.plan === 'combo-dupla') {
                promoNote = "OBS: Promo√ß√£o de Inaugura√ß√£o aplicada. A 1¬™ Mensalidade ter√° o valor reduzido de R$ 59,90.";
            } else if (s.plan === 'combo-familia') {
                promoNote = "OBS: Promo√ß√£o de Inaugura√ß√£o aplicada. A 1¬™ Mensalidade ter√° o valor reduzido de R$ 89,90.";
            }

            let dobDate;
            if (s.dob && s.dob.includes('T')) dobDate = new Date(s.dob);
            else if (s.dob) { const [y, m, d] = s.dob.split('-').map(Number); dobDate = new Date(y, m - 1, d); }
            else dobDate = new Date();
            const formattedDob = `${dobDate.getDate().toString().padStart(2,'0')}/${(dobDate.getMonth()+1).toString().padStart(2,'0')}/${dobDate.getFullYear()}`;
            
            let displayName = 'N√ÉO INFORMADO';
            if(s.plan) {
                if(s.plan === 'combo-dupla') displayName = 'COMBO DUPLA (1 ADULTO + 1 INFANTIL) SEMESTRAL';
                else if(s.plan === 'combo-familia') displayName = 'COMBO FAM√çLIA (2 ADULTOS + 1 INFANTIL) SEMESTRAL';
                else if(s.plan === 'administracao') displayName = 'ADMINISTRA√á√ÉO (ISENTO)';
                else if(s.plan === 'dependente') displayName = 'DEPENDENTE - COMBO FAM√çLIA';
                else displayName = s.plan.replace('infantil-', 'Infantil ').replace('adulto-', 'Jovem/Adulto ').replace('mensal', 'Mensal').replace('trimestral', 'Trimestral').replace('semestral', 'Semestral').toUpperCase();
            }
            
            document.getElementById('printContratante').innerText = s.guardian || s.titularName || s.name;
            document.getElementById('printCPF').innerText = s.cpf || "N√£o informado";
            document.getElementById('printAddress').innerText = s.address || "N√£o informado";
            document.getElementById('printPhone').innerText = s.phone || "N√£o informado";
            document.getElementById('printEmail').innerText = s.email || "N√£o informado";
            
            document.getElementById('printStudent').innerText = s.name;
            document.getElementById('printDob').innerText = formattedDob;
            
            let beltInfo = "";
            if(s.belt && !s.belt.includes("Branca - 0¬∫ Grau") && !s.belt.includes("Iniciante")) {
                beltInfo = `| Gradua√ß√£o Atual: ${s.belt}`;
            }
            document.getElementById('printBeltInfo').innerText = beltInfo;

            document.getElementById('printPlan').innerText = displayName;
            document.getElementById('printPrice').innerText = price;
            document.getElementById('printPromoNote').innerText = promoNote;
            document.getElementById('printPaymentMethod').innerText = s.paymentMethod || "DEFINIDO NO ATO DA MATR√çCULA";
            
            const regDate = s.registrationDate ? new Date(s.registrationDate) : new Date();
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            document.getElementById('printContractDate').innerText = regDate.toLocaleDateString('pt-BR', options);
            document.getElementById('printPaymentDay').innerText = regDate.getDate();

            // LOGIC FOR CLAUSES GENERATION
            const isCombo = s.plan && s.plan.includes('combo');
            const isFidelity = s.plan && (s.plan.includes('semestral') || s.plan.includes('trimestral') || isCombo);

            let clausesHtml = `<p><strong>CL√ÅUSULA 1¬™ - DO OBJETO:</strong> O presente contrato tem por objeto a presta√ß√£o de servi√ßos de ensino e treinamento da arte marcial <strong>JIU-JITSU</strong> pela CONTRATADA ao(s) ALUNO(S) qualificado(s) acima, disponibilizando espa√ßo f√≠sico adequado, instrutores capacitados e hor√°rios pr√©-estabelecidos conforme a grade vigente.</p>`;

            clausesHtml += `<p><strong>CL√ÅUSULA 2¬™ - DO PLANO E VALORES:</strong> O CONTRATANTE opta pelo plano esportivo <strong class="uppercase underline">${displayName}</strong>, comprometendo-se ao pagamento da mensalidade no valor de <strong class="bg-yellow-100 px-1">${price}</strong>. O vencimento ocorrer√° todo dia <strong>${regDate.getDate()}</strong> de cada m√™s corrente.</p>`;

            if (promoNote) {
                 clausesHtml += `<p class="italic text-xs font-bold mb-3">${promoNote}</p>`;
            }

            let clauseNum = 3;

            if (isFidelity) {
                clausesHtml += `<p><strong>CL√ÅUSULA ${clauseNum}¬™ - DO CANCELAMENTO E DA QUEBRA DE CONTRATO (FIDELIDADE):</strong> O plano escolhido possui prazo de fidelidade. O cancelamento exige aviso pr√©vio de 30 dias por escrito. A rescis√£o imotivada antes do t√©rmino do per√≠odo de fidelidade contratado acarretar√° multa rescis√≥ria de 20% (vinte por cento) calculada sobre o valor total das parcelas vincendas (restantes) do contrato.</p>`;
                clauseNum++;
            } else {
                clausesHtml += `<p><strong>CL√ÅUSULA ${clauseNum}¬™ - DO CANCELAMENTO:</strong> O cancelamento da presta√ß√£o de servi√ßos exige aviso pr√©vio de 30 (trinta) dias por escrito √† secretaria da academia. N√£o haver√° reembolso de valores pagos retroativos caso o aluno deixe de frequentar as aulas sem aviso pr√©vio formalizado.</p>`;
                clauseNum++;
            }

            if (isCombo) {
                clausesHtml += `<div class="bg-blue-50 p-2 border-l-2 border-blue-400"><p><strong>CL√ÅUSULA ${clauseNum}¬™ - DAS REGRAS DO PLANO FAM√çLIA (COMBO):</strong> Por se tratar de um pacote promocional vinculado a um grupo familiar:<br>
                a) O pagamento deve ser realizado de forma √∫nica e integral pelo CONTRATANTE (Titular).<br>
                b) O cancelamento, trancamento ou inadimpl√™ncia de UM dos benefici√°rios n√£o d√° direito a reembolso proporcional.<br>
                c) Em caso de sa√≠da de um membro do Combo, o plano dos membros restantes ser√° automaticamente revertido para a tabela de pre√ßos individuais vigente no m√™s do evento.</p></div>`;
                clauseNum++;
            }

            clausesHtml += `<p><strong>CL√ÅUSULA ${clauseNum}¬™ - DA INADIMPL√äNCIA:</strong> O atraso superior a 30 dias no pagamento da mensalidade poder√° acarretar a suspens√£o imediata do acesso aos treinos e cobran√ßa dos valores devidos acrescidos de multa de 2% e juros de mora legais.</p>`;
            clauseNum++;

            clausesHtml += `<p><strong>CL√ÅUSULA ${clauseNum}¬™ - DA SA√öDE E APTID√ÉO F√çSICA:</strong> O CONTRATANTE atesta que o(s) Aluno(s) encontra(m)-se em plenas condi√ß√µes de sa√∫de f√≠sica e mental para a pr√°tica de esportes de combate, isentando a CONTRATADA de qualquer responsabilidade sobre mol√©stias pr√©-existentes n√£o declaradas formalmente no ato desta matr√≠cula.</p>`;
            clauseNum++;

            clausesHtml += `<p><strong>CL√ÅUSULA ${clauseNum}¬™ - DAS REGRAS DE CONDUTA (DOJO KUN):</strong> √â obrigat√≥rio o uso de uniforme (Kimono) estipulado pela academia, limpo e conservado. Atos de indisciplina, desrespeito √† hierarquia, agress√£o fora do contexto do treino esportivo ou falta de higiene poder√£o acarretar na suspens√£o ou rescis√£o unilateral deste contrato por parte da CONTRATADA, sem devolu√ß√£o de valores.</p>`;
            clauseNum++;

            clausesHtml += `<p><strong>CL√ÅUSULA ${clauseNum}¬™ - DO DIREITO DE IMAGEM:</strong> O CONTRATANTE autoriza, a t√≠tulo gratuito, o uso de imagem, voz e nome do(s) Aluno(s) captados nas depend√™ncias da academia ou em eventos externos, para fins de publicidade e marketing da Tanque Team BJJ.</p>`;

            document.getElementById('print-clauses-container').innerHTML = clausesHtml;

            // Dependents Block
            let dependentsHtml = '';
            if (isCombo) {
                let deps = [];
                if (window.titularData && window.titularData.dependentsList) {
                    deps = window.titularData.dependentsList;
                }
                
                if (deps.length > 0) {
                    dependentsHtml = `<p class="mt-2 text-sm"><strong>DEPENDENTES VINCULADOS AO PLANO:</strong></p><ul class="list-disc pl-5 mt-1 text-xs">`;
                    deps.forEach(d => {
                        let dDob = '--/--/----';
                        if(d.dob) { const [y, m, day] = d.dob.split('-').map(Number); dDob = `${day.toString().padStart(2,'0')}/${(m).toString().padStart(2,'0')}/${y}`; }
                        dependentsHtml += `<li><strong>${d.name}</strong> - Nasc: ${dDob} | Parentesco: ${d.parentesco || '-'} | Gradua√ß√£o: ${d.belt || 'Branca'}</li>`;
                    });
                    dependentsHtml += `</ul>`;
                } else {
                    dependentsHtml = `<p class="mt-2 text-xs italic text-gray-500">Nenhum dependente vinculado no sistema no momento.</p>`;
                }
            }
            document.getElementById('printDependentsBlock').innerHTML = dependentsHtml;

            // SIGNATURE NAME
            const signName = s.guardian || s.titularName || s.name;
            document.getElementById('printSignatureName').innerText = signName;
        };

        window.printStudentContract = () => {
            // Imprime sempre o contrato em nome do Titular
            if (window.titularData) {
                document.getElementById('printable-contract').classList.remove('hidden');
                document.getElementById('main-ui').classList.add('hidden');
                window.populateContractDOM(window.titularData);
                
                setTimeout(() => {
                    window.print();
                    document.getElementById('printable-contract').classList.add('hidden');
                    document.getElementById('main-ui').classList.remove('hidden');
                }, 100);
            } else {
                alert("Erro ao gerar contrato.");
            }
        };

        function renderBeltSVG(beltStr) {
            if (!beltStr) return '';
            const colors = { 'Branca': '#ffffff', 'Cinza': '#9ca3af', 'Amarela': '#fbbf24', 'Laranja': '#f97316', 'Verde': '#10b981', 'Azul': '#3b82f6', 'Roxa': '#8b5cf6', 'Marrom': '#78350f', 'Preta': '#000000' };
            let color = '#ffffff'; let degree = 0; let colorName = 'Branca';
            for (const [name, hex] of Object.entries(colors)) { if (beltStr.includes(name)) { color = hex; colorName = name; break; } }
            const degreeMatch = beltStr.match(/(\d)¬∫/); if (degreeMatch) degree = parseInt(degreeMatch[1]);
            const width = 300; const height = 40; const tipWidth = 60; const stripeWidth = 8; const stripeGap = 6;
            let stripesSVG = ''; const barColor = (colorName === 'Preta') ? '#dc2626' : '#000000'; const stripeColor = '#ffffff';
            for (let i = 0; i < degree; i++) { const x = width - 10 - (i * (stripeWidth + stripeGap)) - stripeWidth; stripesSVG += `<rect x="${x}" y="0" width="${stripeWidth}" height="${height}" fill="${stripeColor}" />`; }
            const borderStyle = colorName === 'Branca' ? 'stroke="#e5e7eb" stroke-width="2"' : '';
            return `<svg width="100%" height="100%" viewBox="0 0 ${width} ${height}" preserveAspectRatio="none"><rect x="0" y="0" width="${width}" height="${height}" fill="${color}" ${borderStyle} /><rect x="${width - tipWidth}" y="0" width="${tipWidth}" height="${height}" fill="${barColor}" />${stripesSVG}</svg>`;
        }
    </script>
</body>
</html>
